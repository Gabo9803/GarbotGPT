{% extends "base.html" %}
{% block title %}Xat amb GarBotGPT{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="card shadow-sm border-0 animate__animated animate__fadeIn">
                    <div class="card-body">
                        <h5 class="card-title">Opcions</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <button id="quick-settings" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#quickSettingsModal">Configuració ràpida</button>
                            </li>
                            <li class="list-group-item">
                                <button id="clear-history" class="btn btn-outline-danger w-100">Esborra l'historial</button>
                            </li>
                            <li class="list-group-item">
                                <a href="{{ url_for('export_history') }}" class="btn btn-outline-secondary w-100">Exporta l'historial</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Chat -->
            <div class="col-lg-9">
                <div class="chat-container card shadow-lg border-0 animate__animated animate__fadeIn" id="chat-container-main">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">Xat amb GarBotGPT</h2>
                        <div>
                            <button id="fullscreen-toggle" class="btn btn-outline-secondary btn-sm me-2" title="Alterna pantalla completa" aria-label="Alterna pantalla completa">
                                <i class="fas fa-arrows-alt"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#chatSidebar" aria-controls="chatSidebar">
                                <i class="fas fa-bars"></i>
                            </button>
                        </div>
                    </div>
                    <div id="chat-messages" class="card-body">
                        {% for entry in history %}
                            <div class="message user-message animate__animated animate__fadeIn">
                                <strong>Tu:</strong>
                                <div class="message-content">{{ entry.message | safe }}</div>
                            </div>
                            <div class="message ai-message animate__animated animate__fadeIn">
                                <strong>GarBotGPT:</strong>
                                <div class="message-content markdown-body">{{ entry.response | safe }}</div>
                                <button class="copy-btn btn btn-sm btn-outline-secondary mt-1" data-text="{{ entry.response }}">Copia</button>
                            </div>
                        {% endfor %}
                        <div id="responding-indicator" class="message ai-message animate__animated animate__fadeIn d-none">
                            <strong>GarBotGPT:</strong>
                            <div class="message-content">Responent<span class="dots"></span></div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="message" class="form-control" placeholder="Escriu el teu missatge..." autocomplete="off" aria-label="Missatge">
                            <button class="btn btn-primary btn-gradient" onclick="sendMessage()">Envia</button>
                        </div>
                        <div class="chat-options mt-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="send-on-enter" checked>
                                <label class="form-check-label" for="send-on-enter">Envia amb Enter</label>
                            </div>
                            <button id="regenerate-response" class="btn btn-outline-secondary btn-sm">Regenera la resposta</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Offcanvas Sidebar per a mòbils -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="chatSidebar" aria-labelledby="chatSidebarLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="chatSidebarLabel">Opcions del xat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Tanca"></button>
    </div>
    <div class="offcanvas-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
                <button id="quick-settings-mobile" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#quickSettingsModal">Configuració ràpida</button>
            </li>
            <li class="list-group-item">
                <button id="clear-history-mobile" class="btn btn-outline-danger w-100">Esborra l'historial</button>
            </li>
            <li class="list-group-item">
                <a href="{{ url_for('export_history') }}" class="btn btn-outline-secondary w-100">Exporta l'historial</a>
            </li>
        </ul>
    </div>
</div>

<!-- Modal de configuració ràpida -->
<div class="modal fade" id="quickSettingsModal" tabindex="-1" aria-labelledby="quickSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickSettingsModalLabel">Configuració ràpida</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tanca"></button>
            </div>
            <div class="modal-body">
                <form id="quick-settings-form">
                    <div class="mb-3">
                        <label for="quick-model" class="form-label">Model d'IA</label>
                        <select class="form-select" id="quick-model" name="model">
                            <option value="gpt-3.5-turbo" {% if chat_settings.model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
                            <option value="gpt-4" {% if chat_settings.model == 'gpt-4' %}selected{% endif %}>GPT-4</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quick-temperature" class="form-label">Temperatura</label>
                        <input type="range" class="form-range" id="quick-temperature" name="temperature" min="0" max="1" step="0.1" value="{{ chat_settings.temperature }}">
                        <div class="text-muted">Valor: <span id="temperature-value">{{ chat_settings.temperature }}</span></div>
                    </div>
                    <div class="mb-3">
                        <label for="quick-max-tokens" class="form-label">Màxim de tokens</label>
                        <input type="range" class="form-range" id="quick-max-tokens" name="max_tokens" min="100" max="2000" step="100" value="{{ chat_settings.max_tokens }}">
                        <div class="text-muted">Valor: <span id="max-tokens-value">{{ chat_settings.max_tokens }}</span></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tanca</button>
                <button type="button" class="btn btn-primary btn-gradient" id="save-quick-settings">Desa</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

    // Actualitzar valors dels sliders
    document.getElementById('quick-temperature').addEventListener('input', function() {
        document.getElementById('temperature-value').textContent = this.value;
    });
    document.getElementById('quick-max-tokens').addEventListener('input', function() {
        document.getElementById('max-tokens-value').textContent = this.value;
    });

    // Desar configuració ràpida
    document.getElementById('save-quick-settings').addEventListener('click', async () => {
        const model = document.getElementById('quick-model').value;
        const temperature = parseFloat(document.getElementById('quick-temperature').value);
        const max_tokens = parseInt(document.getElementById('quick-max-tokens').value);
        try {
            const response = await fetch('/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model, temperature, max_tokens })
            });
            const data = await response.json();
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('quickSettingsModal')).hide();
                alert('Configuració desada correctament!');
            } else {
                alert('Error al desar la configuració: ' + data.error);
            }
        } catch (error) {
            alert('Error al desar la configuració: No es pot connectar al servidor');
        }
    });

    // Esborrar historial des del sidebar mòbil
    document.getElementById('clear-history-mobile').addEventListener('click', () => {
        document.getElementById('clear-history').click();
    });
</script>
{% endblock %}